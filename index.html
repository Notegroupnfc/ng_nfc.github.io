<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>NFC Redirect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Arial, sans-serif; padding: 16px; }
    .error { color: #c62828; }
    .info { color: #1565c0; }
    input, button { padding: 8px; margin-top: 8px; }
  </style>
</head>
<body>
  <h3 class="info" id="status">üì≤ ƒêang x·ª≠ l√Ω NFC‚Ä¶</h3>
  <div id="manualInput" style="display:none;">
    <label>Nh·∫≠p ID NFC: </label>
    <input type="text" id="inputId" placeholder="VD: A001">
    <button id="submitId">G·ª≠i</button>
  </div>

<script>
const SHEET_LOG_URL = "https://script.google.com/macros/s/AKfycbxemlxIMJtagonvW6J5Sw9aR1OSunif_150wmJaw6efKiU-4k7huIbfCS-Bkmcq9WmY/exec";
const CSV_FILE = "data.csv";
const statusEl = document.getElementById("status");
const manualInputEl = document.getElementById("manualInput");

function setStatus(msg, isError=false) {
  statusEl.textContent = msg;
  statusEl.className = isError ? "error" : "info";
}

function processId(id) {
  setStatus(`üìÑ ƒêang t√¨m ID: ${id}‚Ä¶`);
  fetch(CSV_FILE)
    .then(res => {
      if (!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y data.csv");
      return res.text();
    })
    .then(csvText => {
      const rows = Papa.parse(csvText, { header: true, skipEmptyLines: true }).data;
      const row = rows.find(r =>
        r.ID && r.ID.trim().toUpperCase() === id.trim().toUpperCase()
      );
      if (!row || !row.LINKS) {
        setStatus(`‚ùå ID "${id}" kh√¥ng t·ªìn t·∫°i`, true);
        return;
      }

      // üîπ Ghi log b·∫±ng GET query string
      const logUrl = `${SHEET_LOG_URL}?id=${encodeURIComponent(row.ID)}&links=${encodeURIComponent(row.LINKS)}&toa_nha=${encodeURIComponent(row.TEN_TOA_NHA || "")}`;
      fetch(logUrl).catch(err => console.log("Log kh√¥ng ·∫£nh h∆∞·ªüng redirect:", err));

      // Redirect
      setStatus("üîÅ ƒêang chuy·ªÉn h∆∞·ªõng‚Ä¶");
      setTimeout(() => window.location.replace(row.LINKS), 300);
    })
    .catch(err => {
      setStatus(`‚ö†Ô∏è L·ªói: ${err.message}`, true);
    });
}

// L·∫•y ID t·ª´ URL
const params = new URLSearchParams(window.location.search);
let id = params.get("id");

if (!id) {
  setStatus("‚ùå Kh√¥ng c√≥ ID NFC, vui l√≤ng nh·∫≠p ID th·ªß c√¥ng");
  manualInputEl.style.display = "block";
  document.getElementById("submitId").onclick = () => {
    const inputId = document.getElementById("inputId").value.trim();
    if (inputId) processId(inputId);
  };
} else {
  processId(id);
}
</script>

</body>
</html>

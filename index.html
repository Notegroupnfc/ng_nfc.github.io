<!DOCTYPE html>
<html>
<head>
    <title>Đồng bộ CSV lên Google Sheets</title>
    <!-- Sử dụng thư viện PapaParse để đọc CSV dễ dàng -->
    <script src="cdnjs.cloudflare.com"></script>
</head>
<body>
    <h2>Đồng bộ dữ liệu từ data.csv</h2>
    <input type="file" id="csvFile" accept=".csv">
    <button onclick="uploadCSV()">Gửi lên Google Sheets</button>
    <p id="status"></p>

    <script>
        const WEB_APP_URL = "URL_CỦA_APPS_SCRIPT_SAU_KHI_DEPLOY";

        function uploadCSV() {
            const fileInput = document.getElementById('csvFile');
            const status = document.getElementById('status');

            if (fileInput.files.length === 0) {
                alert("Vui lòng chọn file data.csv!");
                return;
            }

            status.innerText = "Đang xử lý...";

            // Đọc file CSV
            Papa.parse(fileInput.files[0], {
                header: true, // Tự động lấy dòng đầu làm key (id, toa_nha,...)
                complete: async function(results) {
                    const rows = results.data;
                    let successCount = 0;

                    // Duyệt từng hàng trong CSV và gửi POST
                    for (const row of rows) {
                        if (!row.id) continue; // Bỏ qua hàng trống

                        const payload = {
                            id: row.id,
                            toa_nha: row.toa_nha || row.TEN_TOA_NHA, // Map theo tên cột trong CSV của bạn
                            dia_chi: row.dia_chi || row.DIA_CHI,
                            quan: row.quan || row.Quan,
                            tang: row.tang || row.TANG,
                            vi_tri: row.vi_tri || row.VI_TRI,
                            ua: navigator.userAgent
                        };

                        try {
                            const response = await fetch(WEB_APP_URL, {
                                method: 'POST',
                                mode: 'no-cors', // Cần thiết khi gọi Web App từ domain khác
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            successCount++;
                            status.innerText = `Đã gửi thành công ${successCount}/${rows.length} dòng.`;
                        } catch (error) {
                            console.error("Lỗi khi gửi dòng:", row.id, error);
                        }
                    }
                    status.innerText = "Hoàn tất đồng bộ!";
                }
            });
        }
    </script>
</body>
</html>

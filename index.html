<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>NFC Redirect</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<style>
  body { font-family: system-ui, -apple-system, Arial, sans-serif; padding: 16px; }
  .error { color: #c62828; }
  .info { color: #1565c0; }
</style>
</head>
<body>
<h3 class="info" id="status">ğŸ“² Äang xá»­ lÃ½ NFCâ€¦</h3>

<script>
const SHEET_LOG_URL = "https://script.google.com/macros/s/AKfycbxemlxIMJtagonvW6J5Sw9aR1OSunif_150wmJaw6efKiU-4k7huIbfCS-Bkmcq9WmY/exec";
const CSV_FILE = "https://raw.githubusercontent.com/Notegroupnfc/ng_nfc.github.io/main/data.csv";
const statusEl = document.getElementById("status");

function setStatus(msg, isError=false){
  statusEl.textContent = msg;
  statusEl.className = isError ? "error" : "info";
}

function processId(id){
  setStatus(`ğŸ“„ Äang tÃ¬m ID: ${id}â€¦`);
  fetch(CSV_FILE)
    .then(res => res.text())
    .then(csvText => {
      const rows = Papa.parse(csvText, { header: true, skipEmptyLines: true }).data;
      const row = rows.find(r => r.ID && r.ID.trim().toUpperCase() === id.trim().toUpperCase());
      if(!row || !row.LINKS){
        setStatus(`âŒ ID "${id}" khÃ´ng tá»“n táº¡i`, true);
        return;
      }

      // Gá»­i log báº±ng Image Ping (khÃ´ng bá»‹ CORS)
      const img = new Image();
      img.src = `${SHEET_LOG_URL}?id=${encodeURIComponent(row.ID)}&links=${encodeURIComponent(row.LINKS)}&toa_nha=${encodeURIComponent(row.TEN_TOA_NHA||"")}&ua=${encodeURIComponent(navigator.userAgent)}`;

      // Redirect sang LINK
      setStatus("ğŸ” Chuyá»ƒn hÆ°á»›ngâ€¦");
      setTimeout(()=> window.location.replace(row.LINKS), 300);
    })
    .catch(err => setStatus(`âš ï¸ Lá»—i: ${err.message}`, true));
}

// Láº¥y ID tá»« URL
const params = new URLSearchParams(window.location.search);
const id = params.get("id");

if(!id){
  setStatus("âŒ KhÃ´ng cÃ³ ID NFC, vui lÃ²ng thÃªm ?id=xxxx vÃ o URL", true);
}else{
  processId(id);
}
</script>
</body>
</html>

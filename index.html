<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>NFC Redirect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body>
  <h3>üîÑ ƒêang x·ª≠ l√Ω NFC...</h3>

<script>
const SHEET_LOG_URL = "https://script.google.com/macros/s/AKfycbxemlxIMJtagonvW6J5Sw9aR1OSunif_150wmJaw6efKiU-4k7huIbfCS-Bkmcq9WmY/exec";

const params = new URLSearchParams(window.location.search);
const id = params.get("id");

if (!id) {
  document.body.innerHTML = "<h3>‚ùå Kh√¥ng c√≥ ID NFC</h3>";
} else {

  fetch("data.csv")
    .then(res => {
      if (!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y data.csv");
      return res.text();
    })
    .then(csvText => {
      const rows = Papa.parse(csvText, { header: true, skipEmptyLines: true }).data;

      const row = rows.find(r =>
        r.ID && r.ID.trim().toUpperCase() === id.trim().toUpperCase()
      );

      if (!row || !row.Links) {
        document.body.innerHTML = `<h3>‚ùå ID "${id}" kh√¥ng t·ªìn t·∫°i</h3>`;
        return;
      }

      /* ===== G·ª¨I LOG ===== */
      fetch(SHEET_LOG_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          id: row.ID,
          toa_nha: row.TOA_NHA || "",
          tang: row.TANG || "",
          vi_tri: row.VI_TRI || "",
          ua: navigator.userAgent
        })
      });

      /* ===== REDIRECT ===== */
      window.location.replace(row.Links);
    })
    .catch(err => {
      document.body.innerHTML = `<h3>‚ö†Ô∏è L·ªói: ${err.message}</h3>`;
    });
}
</script>

</body>
</html>

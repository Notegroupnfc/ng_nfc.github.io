<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>NFC Smart System - Notegroup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Thư viện xử lý dữ liệu CSV -->
  <script src="cdn.jsdelivr.net"></script>
  
  <style>
    :root { --primary: #007aff; --bg: #f5f5f7; --error: #ff3b30; }
    body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; color: #1d1d1f; }
    .container { background: white; padding: 2.5rem; border-radius: 24px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); width: 90%; max-width: 380px; text-align: center; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .status { font-size: 1.1rem; font-weight: 600; color: var(--primary); margin-bottom: 10px; }
    #manualInput { display: none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
    input { width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 10px; margin-bottom: 12px; box-sizing: border-box; font-size: 16px; }
    button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; }
    .error-text { color: var(--error); font-size: 0.9rem; }
  </style>
</head>
<body>

  <div class="container">
    <div id="loader" class="loader"></div>
    <div id="status" class="status">Đang định vị NFC...</div>
    
    <div id="manualInput">
      <p class="error-text">Không tìm thấy mã hoặc mã không hợp lệ.</p>
      <input type="text" id="inputId" placeholder="Nhập mã ID (VD: TTS-BA-G1.1)">
      <button id="submitId">Xác nhận</button>
    </div>
  </div>

<script>
/**
 * CẤU HÌNH HỆ THỐNG 2025
 */
const SHEET_LOG_URL = "script.google.com";
const CSV_FILE = "data.csv"; 

const statusEl = document.getElementById("status");
const loaderEl = document.getElementById("loader");
const manualInputEl = document.getElementById("manualInput");

function setUIState(msg, isError = false) {
  statusEl.textContent = msg;
  statusEl.style.color = isError ? "var(--error)" : "var(--primary)";
  loaderEl.style.display = isError ? "none" : "block";
  if (isError) manualInputEl.style.display = "block";
}

function processRedirect(nfcId) {
  if (!nfcId) return;
  const targetId = nfcId.trim();
  setUIState(`Đang xử lý ID: ${targetId}...`);

  // Tải file data.csv từ GitHub
  fetch(CSV_FILE)
    .then(res => {
      if (!res.ok) throw new Error("Không thể tải danh sách dữ liệu CSV.");
      return res.text();
    })
    .then(csvText => {
      const result = Papa.parse(csvText, { header: true, skipEmptyLines: true });
      // Tìm dòng dữ liệu khớp với ID (Không phân biệt hoa thường)
      const foundRow = result.data.find(r => r.ID && r.ID.trim().toUpperCase() === targetId.toUpperCase());

      if (!foundRow || !foundRow.LINKS) {
        throw new Error(`ID "${targetId}" chưa được đăng ký.`);
      }

      // Gửi Log về Google Sheets (Theo Header yêu cầu: ID, THOI_GIAN, TEN_TOA_NHA, LINKS)
      const query = new URLSearchParams({
        id: foundRow.ID,
        toa_nha: foundRow.TEN_TOA_NHA || "",
        links: foundRow.LINKS
      });

      // Gửi ngầm (no-cors) để tối ưu tốc độ người dùng
      fetch(`${SHEET_LOG_URL}?${query.toString()}`, { mode: 'no-cors' });

      setUIState("✅ Thành công! Đang chuyển hướng...");

      // Chuyển hướng người dùng sau 0.5 giây
      setTimeout(() => {
        window.location.replace(foundRow.LINKS);
      }, 500);
    })
    .catch(err => {
      setUIState(err.message, true);
    });
}

// Lấy ID từ URL: ?id=XYZ
const urlParams = new URLSearchParams(window.location.search);
const idParam = urlParams.get("id");

if (idParam) {
  processRedirect(idParam);
} else {
  setUIState("Vui lòng quét thẻ NFC", true);
}

// Xử lý nút bấm thủ công
document.getElementById("submitId").onclick = () => {
  const inputVal = document.getElementById("inputId").value;
  if (inputVal) {
    manualInputEl.style.display = "none";
    processRedirect(inputVal);
  }
};
</script>
</body>
</html>

<script>
const SHEET_LOG_URL = "https://script.google.com/macros/s/AKfycbxemlxIMJtagonvW6J5Sw9aR1OSunif_150wmJaw6efKiU-4k7huIbfCS-Bkmcq9WmY/exec";

const params = new URLSearchParams(window.location.search);
const id = params.get("id");

if (!id) {
  document.body.innerHTML = "<h3>❌ Không có ID NFC</h3>";
} else {
  fetch("data.csv")
    .then(res => res.text())
    .then(csvText => {
      const rows = Papa.parse(csvText, { header: true, skipEmptyLines: true }).data;

      const row = rows.find(r =>
        r.ID && r.ID.trim().toUpperCase() === id.trim().toUpperCase()
      );

      if (!row || !row.LINKS) {
        document.body.innerHTML = `<h3>❌ ID "${id}" không tồn tại</h3>`;
        return;
      }

      // GỬI LOG
      fetch(SHEET_LOG_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          id: row.ID,
          toa_nha: row.TEN_TOA_NHA || "",
          dia_chi: row.DIA_CHI || "",
          quan: row.Quan || "",
          tang: row.TANG || "",
          vi_tri: row.VI_TRI || "",
          ua: navigator.userAgent
        })
      });

      // REDIRECT
      window.location.replace(row.LINKS);
    })
    .catch(err => {
      document.body.innerHTML = `<h3>⚠️ Lỗi: ${err.message}</h3>`;
    });
}
</script>

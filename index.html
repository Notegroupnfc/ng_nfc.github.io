<script>
const SHEET_LOG_URL = "https://script.google.com/macros/s/AKfycbyCK7breihiKuXSMFlfx8EHRxtCKXvMJ3Qdbww5CwE0HhDaOCaxusdnmMPnoprSRQsF/exec";
const CSV_FILE = "data.csv";
const API_KEY = "NFC_2025_SECRET";

const statusEl = document.getElementById("status");
const loaderEl = document.getElementById("loader");
const manualInputEl = document.getElementById("manualInput");

function setUI(msg, error = false) {
  statusEl.textContent = msg;
  statusEl.style.color = error ? "var(--error)" : "var(--primary)";
  loaderEl.style.display = error ? "none" : "block";
  manualInputEl.style.display = error ? "block" : "none";
}

async function loadCSV() {
  const res = await fetch(CSV_FILE);
  if (!res.ok) throw new Error("Không tải được CSV");
  const text = await res.text();
  return Papa.parse(text, { header: true, skipEmptyLines: true }).data;
}

async function processID(id, source) {
  if (!id) return;
  const target = id.trim().toUpperCase();
  setUI(`Đang xử lý ID: ${target}...`);

  try {
    const data = await loadCSV();
    const row = data.find(r => r.ID?.trim().toUpperCase() === target);
    if (!row || !row.LINKS) throw new Error("ID chưa đăng ký");

    if (source === "nfc") {
      const params = new URLSearchParams({
        id: row.ID,
        toa_nha: row.TEN_TOA_NHA || "",
        links: row.LINKS,
        source: "nfc",
        key: API_KEY
      });

      fetch(`${SHEET_LOG_URL}?${params}`)
        .then(res => res.json())
        .then(data => {
          if (data?.count) {
            setUI(`✅ ID đã được quét ${data.count} lần`);
            setTimeout(() => location.replace(row.LINKS), 1200);
          } else {
            location.replace(row.LINKS);
          }
        })
        .catch(() => location.replace(row.LINKS));

    } else {
      location.replace(row.LINKS);
    }

  } catch (e) {
    setUI(e.message, true);
  }
}

const urlParams = new URLSearchParams(location.search);
const idParam = urlParams.get("id");
const sourceParam = urlParams.get("source");

if (idParam) processID(idParam, sourceParam);
else setUI("Vui lòng quét thẻ NFC", true);

document.getElementById("submitId").onclick = () => {
  const v = document.getElementById("inputId").value;
  if (v) processID(v, "manual");
};
</script>

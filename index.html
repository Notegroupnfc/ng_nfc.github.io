<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğŸ“¡ NFC Scan</title>
<style>
body { font-family: Arial; text-align:center; padding:40px; }
#status { font-size:18px; margin-top:20px; margin-top:20px; }
</style>
</head>
<body>
<h2>ğŸ“¡ NFC Scan</h2>
<p>Upload data.csv trÆ°á»›c:</p>
<input type="file" id="csvFile" accept=".csv"><br><br>
<p id="status">ChÆ°a cÃ³ dá»¯ liá»‡u</p>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script>
let csvData = {};

document.getElementById("csvFile").addEventListener("change", function(e){
  const file = e.target.files[0];
  if(!file) return;
  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: function(results){
      csvData = {};
      results.data.forEach(row => {
        if(row.ID) csvData[row.ID] = {TEN_TOA_NHA: row.TEN_TOA_NHA, LINK: row.LINK};
      });
      document.getElementById("status").innerText = "âœ… CSV Ä‘Ã£ load thÃ nh cÃ´ng!";
      console.log("CSV data:", csvData);
    }
  });
});

// Láº¥y ID tá»« URL NFC vÃ  redirect
const params = new URLSearchParams(window.location.search);
const id = params.get("id");

function redirectNFC() {
  if(!id) {
    document.getElementById("status").innerText = "âŒ KhÃ´ng cÃ³ ID!";
    return;
  }

  if(!csvData[id]) {
    document.getElementById("status").innerText = "âŒ ID khÃ´ng cÃ³ trong CSV, dÃ¹ng link máº·c Ä‘á»‹nh";
    window.location.href = "https://notegroupnfc.github.io/ng_nfc.github.io/index.html?id=" + encodeURIComponent(id);
    return;
  }

  const link = csvData[id].LINK;
  document.getElementById("status").innerText = "âœ… QuÃ©t NFC thÃ nh cÃ´ng! Chuyá»ƒn hÆ°á»›ng...";
  
  // Ghi log background
  const webAppURL = "https://script.google.com/macros/s/AKfycbxTi0fXYzISLRLZiVc86XcEqhhoMgr8DkNG66tCXRjymWoGL-6rcRvp4-J0R6-S1vDe/exec"; // Thay YOUR_SCRIPT_ID
  fetch(webAppURL + "?id=" + encodeURIComponent(id))
    .finally(() => {
      window.location.href = link; // Redirect ngay sau khi gá»­i log
    });
}

// Chá» CSV load trÆ°á»›c khi redirect
document.getElementById("csvFile").addEventListener("change", () => {
  setTimeout(redirectNFC, 500); // delay nhá» cho CSV parse
});
</script>
</body>
</html>
